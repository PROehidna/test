//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
//Разработчит проекта: Доронин Всеволод Михайлович, студент группы 1192б.
//
//Цель: разработать программу для вывода чисел в четырнадцатиричной системе счисления на семисегментном индикаторе
//
//Решамые проектом задачи:
//	1. Реализовать режим, при котором последовательно загораются слева направо, а потом последовательно слева направо гаснут светодиоды.
//	2. Реализовать режим, при котором слева направо «бежит» один огонек.
//	3. Реализовать выбор режима работы используя микропереключатель SW1.
//	4. Реализовать реверсный режим микропереключателем SW2.
//	5. Реализовать управление временем задержки используя микропереключатели SW3 и SW4.
//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
#include "main.h" 																																																				  /* Заголовчоный файл с описанием подключаемых библиотечных модулей. 																																																				 																														  */
																																																													  /*																																																																																			    									    																			  */																																																																																																																	 																																																																																																																																														 /* */
																																																													  /* main() - обязательная функция для исполнения кода пользователя. 																																																			  																														    */
																																																													  /* После подачи питания или щелчка кнопкой "reset" стартует Загрузчик, который выполняет начальную настройку основых регистров микроконтроллера. 												  																														    */
																																																													  /* В завершение работы Загрузчик передаёт управление микроконтроллером функции main. 																																										  																														    */
																																																													  /*																																																																																	  		   																														  */																																																																																																																	
int main(void)																																																						  /*  																																																																																																																			*/
{																																																													  /*  																																																																																																																			*/
	RCC->AHBENR |= RCC_AHBENR_GPIOBEN; 																																											  /*  																																																																																																																			*/
	GPIOB->MODER|=GPIO_MODER_MODER0_0 | GPIO_MODER_MODER1_0 | GPIO_MODER_MODER2_0 | 											                   	/* Переключение линий 0-8 порта B в режим "Output": 													GPIO_MODER_MODER0_0=0x1;    GPIO_MODER_MODER1_0=0x4;  	 GPIO_MODER_MODER2_0=0x10;   					 																															*/
								GPIO_MODER_MODER3_0 | GPIO_MODER_MODER4_0 | GPIO_MODER_MODER5_0 |											 									   	/* Тождественно будет написать GPIOB->MODER|=0x15555													GPIO_MODER_MODER3_0=0x40;   GPIO_MODER_MODER4_0=0x100;  GPIO_MODER_MODER5_0=0x400;	 					 																															*/
								GPIO_MODER_MODER6_0 | GPIO_MODER_MODER7_0 | GPIO_MODER_MODER9_0;																					 	/*																									 													GPIO_MODER_MODER6_0=0x1000; GPIO_MODER_MODER7_0=0x4000; GPIO_MODER_MODER8_0=0x1000. 					 																															*/
	GPIOB->MODER&=~( GPIO_MODER_MODER12 | GPIO_MODER_MODER13 | GPIO_MODER_MODER14 | GPIO_MODER_MODER15); 								  	  /* Переключение 12-15 (SW4-SW1) линий порта в режим "Input" -> положение 00 для каждой пары битов в данном регистре соответствует режиму ввода данных.											 																															*/
	uint16_t bitness = 14;																																																		/* Разрядность системы счисления. 																																																																																																				*/
	uint16_t in[8] = {0, 1, 0, 0, 1, 0, 0, 0} ;																																								/* Массив с входными данными в двоичной системе счисления. 																								 																																 																																*/
	uint16_t n = 0;																																																						/* Число, получаемое при считывании данных с переключателей.  																						 																																 																																*/
	uint16_t out[3] = {0,0,0};																																																/* Массив с выходными данными в системе счисления четырнадцатиричной для вывода на семисегментый индикатор.																																 																																*/		
																																																														/*  																																																																																																																			*/
	unsigned reg[14] = {0x23F, 0x206, 0x25B, 0x24F, 0x266, 0x26D, 0x27D, 0x207, 0x27F, 0x26F, 0x277, 0x27C, 0x239, 0x25E};		/* Масссив с данными о кодориовке чисел (0-D) на семисегментом индикаторе и установка логической "1" на линию порта PB.9 для разрешения работы семисегментного индикатора. 																																*/
																																																														/*  																																																																																																																			*/
	while(1)																																																									/* Реализация вывода на семисегментый индикатор. 																													 																																 																																*/
	{																																																													/*  																																																																																																																			*/																																															
		n=0;																																																										/* Сброс значения в начале цикла для обновления данных. 																									 																																 																																*/
		in[0]=((GPIOB->IDR)&0x8000)>>15;																																												/* Считывание данных с переключателя SW1. 														  																	 																																 																																*/
		in[2]=((GPIOB->IDR)&0x4000)>>14;																																												/* Считывание данных с переключателя SW2. 														  																	 																																 																																*/
		in[5]=((GPIOB->IDR)&0x2000)>>13;																																												/* Считывание данных с переключателя SW3. 														  																	 																																 																																*/
		in[6]=((GPIOB->IDR)&0x1000)>>12;																																												/* Считывание данных с переключателя SW4. 														  																	 																																 																																*/						
		uint32_t j=7;																																																						/* Переменная, указывающая на порядок числа в массиве бинарного числа.  																	 																																 																																*/
																																																														/*  																																																																																																																			*/
		for (uint16_t i = 0 ; i<8; i++)																																													/* Перевод числа в десятичную систему. 																  																	 																																 																																*/
		{																																																												/*  																																																																																																																			*/
			n += in[i]* pov(2, j);																																																/* Расчет числа в десятичной системе. Применяется метод pov(), написанный в угоду оптимизации и неиспользования библиотеки. 																							 																																*/
			j--;																																																									/* Уменьшение разряда числа. 						 															  																	 																																 																																*/
		}																																																												/*  																																																																																																																			*/
																																																														/*  																																																																																																																			*/
		for (uint16_t i = 0 ; i<bitness; i++)																																										/* Перевод числа в четырнадцатиричную систему.  											  																	 																																 																																*/
		{         																																																							/*  																																																																																																																			*/
			if(n<bitness) 																																																				/* Проверка на размер числа относительно разрядности. Если число меньше - условие не сработает.  																																																															            */
			{																																																											/*  																																																																																																																			*/
				out[i] = n;																																																					/* Запись значения числа в выходной массив. 																																																																																															*/
				break;																																																							/* Прерывание цикла. 																																																																																																											*/
			}																																																											/*  																																																																																																																			*/
			out[i] = n%bitness;																																																		/* Запись остатка от деления числа в выходной массив. 																																																																																										*/
			n = n/bitness;																																																				/* Число перезаписывается и становится целочисленным остатком от деления на разрядность.  																																																																								*/
		} 																																																											/*  																																																																																																																			*/
																																																														/*  																																																																																																																			*/
		for (int16_t i = 2; i>-1; i--)																																													/* Вывод числа на семисегментном индикаторе. Обработка выходного массива.  																																																																																*/
		{																																																												/*  																																																																																																																			*/
			if(i == 2 & out[i]== 0)																																																/* Отмена вывода "0" в старшем значении числа. 				   																																																																																									*/
			{																																																											/*  																																																																																																																			*/
				continue;																																																						/*  																																																																																																																			*/
			}																																																											/*  																																																																																																																			*/
			GPIOB->BSRR|=reg[out[i]];																																															/* Вывод цифры числа, записанной в массив с выходными данными.  																																																																																					*/
			delay(200000);																																																				/* Задержка в ~2 секунды после вывода числа. 						 																																																																																									*/
			GPIOB->BSRR|=0xffff0000;																																															/* Выключение индикатора. 															 																																																																																									*/
			delay(50000);																																																					/* Задержка в ~0.5 секунд после выключения индикатора. 	 																																																																																									*/
		}																																																												/*  																																																																																																																			*/
		GPIOB->BSRR|=0x00000280;																																																/* Вывод точки на индикаторе. 													 																																																																																									*/
		delay(500000);																																																					/* Задержка в ~5 секунд после выключения индикатора. 	   																																																																																									*/
		GPIOB->BSRR|=0xffff0000;																																																/* Выключение индикатора. 															 																																																																																									*/
	} 																																																												/*  																																																																																																																			*/
}   																																																												/*  																																																																																																																			*/
																																																														/*  																																																																																																																			*/
uint32_t pov(uint32_t x, uint32_t n)																																												/* pov() - функция вычисления степени числа (находится в открытом доступе). 																					                      			 	 																																											*/
{																																																													  /* Входные данные: x - число, возодимое в степень 																																		                      			 	 																																											*/
    if (n==0)																																																								/* Если степень равна 0  																																															                      			 	 																																											*/
        return 1; 																																																					/*  										возвращается 1. 																																							                      			 	 																																											*/
    else if (n==1	)																																																					/* Если степень равна 1  																																															                      			 	 																																											*/
        return x;																																																						/*                      возвращается число. 																																					                      			 	 																																											*/
    else if (n % 2 == 0 )																																																		/* Если степень четная   																																															                      			 	 																																											*/
			return pov( x * x, n/2);																																														  /*                     производится рекурсия, во входных параметрах число умноженное само на себя и половина степени.                       			 	 																																											*/
    else																																																										/* Если степень нечетная 																																															                      			 	 																																											*/
        return pov( x * x, n /2)*x;																																													/*                       производится рекурсия, во входных параметрах число умноженное само на себя и половина степени. Результат умножается на число																																											*/
 }																																																													/*  																																																																																																																			*/
																																																													  /*	Функция задержки: count - количество элементарных периодов задрежки с длительностью примерно 2.5 мкс. 																																																																*/
void delay(uint32_t count)      																																													  /*																																																																																																																				*/
{ 																																																												  /*																																																																																																																				*/
for (uint32_t i=0;i<count;i++);																																													    /*	Выполнение пустых циклов для реализации программной задержки.																																																																																					*/
} 																																																												  /*																																																																																																																				*/
//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
//Руководство пользователя:
//	1. Для запуска загруженной программы удалите перемычку "boot" на стенде и нажмите "reset" .
//  2. Число задаётся с помощью переключателей SW1, SW2, SW3, SW4.
//	3. Задаваемое число имеет вид: (SW1) 1 (SW2) 0 1 (SW3) (SW4) 0.
//	4. На семисегментном индикаторе, начиная со старшей цифры, выводится число, в окончании выводится точка.
//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
