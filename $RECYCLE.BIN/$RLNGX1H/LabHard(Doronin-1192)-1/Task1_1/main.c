//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
//Разработчит проекта: Доронин Всеволод Михайлович, студент группы 1192б.
//
//Цель: обучиться работе с портами ввода/вывода общего назначения (GPIO); разработать программу на языке C, реализующую мигание светодиода.
//
//Решаемые проектом задачи:
//	1. Реализовать мигание светодиода
//	2. Реализовать управление временем задержки используя микропереключатели SW3 и SW4
//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
#include "main.h" 																						/* Заголовчоный файл с описанием подключаемых библиотечных модулей 																																																																																			 */
																															/*																																																																																																																		   */																																																																																																																	 /* */																																																																																																																																															 /* */
																															/* main() - обязательная функция для исполнения кода пользователя. 																																																																																		   */
																															/* После подачи питания или щелчка кнопкой "reset" стартует Загрузчик, который выполняет начальную настройку основых регистров микроконтроллера. 																																											   */
																															/* В завершение работы Загрузчик передаёт управление микроконтроллером функции main. 																																																																									   */
																															/*																																																																																																																		   */																																																																																																																	 /* */
int main(void)																								/*																																																																																																																	     */																																																																																																																	 /* */
{																															/*																																																																																																																		   */																																																																																																																	 /* */
	uint32_t half_period;																				/* Половина переиода мигания светодиода. 																																																																																 		                             */
	uint32_t n;																									/* Степень коэффициента базовой задержки K=2^n.																																																																						 														                   */
	RCC->AHBENR|=RCC_AHBENR_GPIOBEN;														/* Включение тактирования порта B RCC_AHBENR_GPIOBEN=0x00040000 -> 18 бит данного регистра отвечает за вкл./выкл. тактирования порта B. 											 																	 	                                       */
																															/*																																																																																																																		   */																																																																																																																	 /* */
	GPIOB->MODER|=GPIO_MODER_MODER0_0 | GPIO_MODER_MODER8_0;		/* Переключение линий 0 и 8 порта B в режим "Output": GPIO_MODER_MODER0_0=0x1; GPIO_MODER_MODER8_0=0x10000 -> для каждой из линий в данном регистре задействоано 2 бита, положение 01 для каждой пары соответствует режиму вывода данных.*/
	GPIOB->MODER&=~( GPIO_MODER_MODER12 | GPIO_MODER_MODER13);	/* Переключение 12(SW4) и 13(SW3) линий порта в режим "Input" -> положение 00 для каждой пары битов в данном регистре соответствует режиму ввода данных.															 																									 */
	GPIOB->ODR|=0x100; 																					/* Разрешение работы светодиодов на стенде STM_01 с помощью установки логической "1" на выводе PB.8.																																																				 													   */
	half_period = 50000;																				/* Задание величины базовой задержки. 																																																																																			 											   	   */
																															/* Реализация процесса мигания светодиода. 																																																																																													 	   */
	while(1)																										/*																																																																																																																		 	 */																																																																																																																	 /* */
	{																														/*																																																																																																																		   */
		n=((GPIOB->IDR)&0x3000)>>12;															/* Определение степени коэффициента базовой задержки: K=2^n.																																																																			 																	     */
		GPIOB->BSRR|=0x1;																					/* Зажечь светодиод, подключенный к выводу PB.0 -> установка логической "1" на линии PB.0 - биты 0-15 в данном регистре отвечают за устновку значений. 																												 												   */
		delay(half_period<<n);																		/* Задержка после включения светодиода.																																																																																															     */
		GPIOB->BSRR|=0x10000;																			/* Погасить светодиод, подключенный к выводу PB.0 -> установка логической "0" на линии PB.0 - биты 16-31 в данном регистре отвечают за сброс значений. 																										 														   */
		delay(half_period<<n);																		/* Задержка после выключения светодиода.																																																																																															   */
	}																														/*																																																																																																																		   */																																																												 																																																	         /* */
}																															/*																																																																																																																		   */																																																											 																																																			       /* */
																															/*																																																																																																																		   */																																																																																																																	 /* */
																															/* Функция задержки: count - количество элементарных периодов задрежки с длительностью примерно 2.5 мкс. 																																																														     */
void delay(uint32_t count)																		/*																																																																																																																		   */																																																																																																												           /* */
{																															/*																																																																																																																		   */																																																																																																																	 /* */
	for (uint32_t i=0;i<count;i++);															/* Выполнение пустых циклов для реализации программной задержки. 																																																																								             					   */
}																															/*																																																																																																																		   */																																																																																																																	 /* */
//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
//Руководство пользователя:
//		1. Для запуска загруженной программы удалите перемычку "boot" на стенде и нажмите кнопку "reset".
//		2. В управлении частотой мигания светодиода используйте микропереключатели SW3(старший разряд) и SW4 (младший разряд).
//		3. Примерная частота мигания: 00 - 4 Гц; 01 - 2 Гц; 10 - 1 Гц; 11 - 0.5 Гц.
//		4. Интервал между переключениями светодиода задается с помощью программной задержки.
//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
