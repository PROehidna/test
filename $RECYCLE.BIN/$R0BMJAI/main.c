//----------------------------------------------------------------------------------------------------------------------------------------------
//??????????? ???????: ??????? ???????? ????????? - ?????? 1191?
//
//????: ??????????? ????????? ??? ?????? ????? ? ??????????? ??????? ????????? ?? ?????????????? ??????????
//
//???????? ???????? ??????:
//	1. ?? ?????? ??????????? ? ??????????? ???  ?????????? ???????? ????? ? ?????????? ??????? ?????????
//	2. ??????????????? ????? ?? ?????????? ??????? ????????? ? ??????? ? ?????????? ??????
//	3. ?????????? ?????? ????? ????? ???????? ??? ??????????????? ??????????
//	4. ???????? ??? ????? ????? ?? ?????????????? ??????????, ??????? ?? ??????? ?????.
//----------------------------------------------------------------------------------------------------------------------------------------------

#include "main.h"	//???????????? ???? ? ????????? ???????????? ???????????? ???????

//main ???????????? ??????? ??? ?????????? ???? ????????????
//????? ?????? ??????? ??? ?????? ??????? "reset" ???????? ??????????, ??????? ????????? ????????? ????????? ??????? ????????? ???????????????? 
//? ?????????? ?????? ????????? ???????? ?????????? ????????????????? ??????? main
int main(void)
{
	//???????????????? ?????? GPIO 
	RCC->AHBENR |= RCC_AHBENR_GPIOBEN; 																							 		//????????? ???????????? ????? B: RCC_AHBENR_GPIOBEN=0x00040000			
	GPIOB->OSPEEDR |= 0x00005555;																												//????????? ??????? ???????????? ??????? PB.0 – PB.7 ?? ?????? 10 ???
	GPIOB->MODER |= GPIO_MODER_MODER0_0 | GPIO_MODER_MODER1_0 | GPIO_MODER_MODER2_0 |		//???????????? ????? 0-7 ? 9 ????? B ? ????? "Output"
									GPIO_MODER_MODER3_0 | GPIO_MODER_MODER4_0 | GPIO_MODER_MODER5_0 |
									GPIO_MODER_MODER6_0 | GPIO_MODER_MODER7_0 | GPIO_MODER_MODER9_0;
	GPIOB->MODER&=~( GPIO_MODER_MODER12 | GPIO_MODER_MODER13 |  												//??????????? ????? 12(SW4),13(SW3),14(SW2),15(SW1)????? B ? ????? "Input"
									 GPIO_MODER_MODER14 | GPIO_MODER_MODER15);													
	
	uint16_t input[8] = {0, 0, 0, 0, 1, 0, 1, 0} ;																			//??????? ???????? ????? (? ???????? ???????)
	uint16_t n = 0;																																			//???????? ????? ? ?????????? ???????
	uint16_t output[3] = {0,0,0};																												//?????? ? ?????? ? ??????????? ??????? (? ???????? ???????)
	unsigned reg[14] = {0x23F, 0x206, 0x25B, 0x24F, 0x266, 0x26D, 0x27D, 0x207, 0x27F, 0x26F, 0x277, 0x27C, 0x239, 0x25E};									//???????? ??????????????? ??????????, ????? 0,1,2,3 ??????????????
	//?????????? ?????? ?? ?????????????? ?????????
	while(1){
		n=0;
		input[0]=((GPIOB->IDR)&0x8000)>>15;																								//?????????? ???????? ????????????? SW1
		input[1]=((GPIOB->IDR)&0x4000)>>14;																								//?????????? ???????? ????????????? SW2
		input[2]=((GPIOB->IDR)&0x2000)>>13;																								//?????????? ???????? ????????????? SW3
		input[5]=((GPIOB->IDR)&0x1000)>>12;																								//?????????? ???????? ????????????? SW4
		uint32_t j=7;																																			//?????? ????????? ?????
		//??????? ????? ? ?????????? ???????
		for (uint16_t i = 0 ; i<8; i++){         
			n += input[i]* powi (2, j);																											//?????? ????? ? ?????????? ???????
			j--;																																						//??????? ? ?????????? ???????
		}
		//??????? ????? ? ??????????? ???????
		for (uint16_t i = 0 ; i<8; i++){       
			if(n<8) {																																				//??????? ???????????, ???? ?????????? ????? ?????? ???????????
				output[i] = n;																																//? ???????? ?????? ???????????? ???????? ?????
				break;																																				//???? ???????????
			}
			output[i] = n%8;																																//? ???????? ?????? ???????????? ??????? ?? ??????? ?? 4 
			n = n/8;																																				//? ????? n ???????????? ????? ????? ?? ???????
		} 
		//????? ????? ?? ?????????????? ??????????
		for (int16_t i =3; i>=0; i--){
			if(i == 3 & output[i]== 0){																											//??????????? 0 ? ??????? ????? ????? (???? ?? ????)
				continue;}
			GPIOB->BSRR|=reg[output[i]];																										//????? ????? ?????
				delay(200000);																																//???????? ? 2 ???????
				GPIOB->BSRR|=0xffff0000;																											//?????????? ??????????
			delay(50000);																																		//???????? ? 0,5 ???????
		}
		GPIOB->BSRR|=0x00000280;																													//????? ?????
		delay(500000);																																		//???????? ? 5 ?????? 
		GPIOB->BSRR|=0xffff0000;																													//?????????? ??????????
	}
}

//powi ??????? ??? ?????????? ??????? ?????
//x - ????? ?????? ????? ???????? ? ???????, n - ??????? ? ??????? ????? ????????
//?????????? ????? ??????????? ? ???????
uint32_t powi(uint32_t x, uint32_t n)
{
    if (n==0)																																					//???? ??????? ????? 0
        return 1;																																				//???????????? ???????
    else if (n==1)																																		//???? ??????? ????? 
			return x;																																					//???????????? ??????? ?????
    else if (n % 2 == 0 )																															//???? ??????? ??????
			return powi( x * x, n/2);																													//???????????? ????????, ?????????? ????? ?????????? ?? ???? ? ???????? ???????
    else																																							//???? ??????? ????????
        return powi( x * x, n /2)*x;																										//???????????? ????????, ?????????? ????? ?????????? ?? ???? ? ???????? ???????
}																																											//????????? ??????????? ?? ??????? ?????

//??????? ????????: count - ?????????? ???????????? ???????? ???????? ? ????????????? ???????? 2,5 ???
void delay(uint32_t count)
{
	volatile uint32_t i;																																//????????? ???????????????? ??????????
	for (i =0;i<count;i++);																															//?????????? ?????? ?????? ??? ?????????? ?????????? ????????
}
//----------------------------------------------------------------------------------------------------------------------------------------------
//??????????? ????????????:
//	1. ??? ??????? ??????????? ????????? ??????? ????????? "boot" ?? ?????? ? ??????? "reset" 
//  2. ????? ???????? ? ??????? ?????????????? SW1, SW2, SW3, SW4
//	3. ?????????? ????? ????? ???: 0 (SW1) 1 1 (SW2) 0 (SW3) (SW4)
//	4. ?? ?????????????? ??????????, ??????? ?? ??????? ?????, ????????? ?????, ? ????????? ????????? ?????
//----------------------------------------------------------------------------------------------------------------------------------------------

